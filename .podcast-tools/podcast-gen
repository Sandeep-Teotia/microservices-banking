#!/root/.local/share/uv/tools/notebooklm-mcp-server/bin/python
import sys
import argparse
from pathlib import Path

# Add library path
sys.path.append("/root/.local/share/uv/tools/notebooklm-mcp-server/lib/python3.11/site-packages")

try:
    from notebooklm_mcp.server import get_client
except ImportError:
    print("Error: Could not import notebooklm_mcp library.")
    sys.exit(1)

def main():
    parser = argparse.ArgumentParser(description="Generate a NotebookLM Audio Podcast.")
    parser.add_argument("file", help="Path to the text/markdown file to process")
    parser.add_argument("--lang", default="en", help="Language code (en, hi, es, etc.)")
    parser.add_argument("--prompt", default="", help="Focus prompt for the audio generation")
    parser.add_argument("--title", default=None, help="Custom title for the notebook")
    
    args = parser.parse_args()
    
    file_path = Path(args.file).resolve()
    if not file_path.exists():
        print(f"Error: File not found: {file_path}")
        sys.exit(1)

    # Use provided title or default to filename stem
    notebook_title = args.title if args.title else file_path.stem

    print(f"--- NotebookLM Podcast Generator ---")
    print(f"File: {file_path.name}")
    print(f"Language: {args.lang}")
    print(f"Notebook Title: {notebook_title}")
    if args.prompt:
        print(f"Prompt: {args.prompt}")

    print("\nAuthenticating...")
    try:
        client = get_client()
    except Exception as e:
        print(f"Auth failed: {e}")
        sys.exit(1)

    print(f"Creating notebook '{notebook_title}'...")
    try:
        notebook = client.create_notebook(title=notebook_title)
        print(f"Notebook ID: {notebook.id}")
    except Exception as e:
        print(f"Failed to create notebook: {e}")
        sys.exit(1)

    print("Uploading source...")
    try:
        text_content = file_path.read_text(encoding='utf-8')
        source = client.add_text_source(notebook.id, text=text_content, title=file_path.name)
        source_id = source['id']
    except Exception as e:
        print(f"Failed to add source: {e}")
        sys.exit(1)

    print("Generating Audio Overview...")
    try:
        client.create_audio_overview(
            notebook.id, 
            source_ids=[source_id],
            language=args.lang,
            focus_prompt=args.prompt
        )
        print(f"Audio generation started.")
    except Exception as e:
        print(f"Failed to start audio generation: {e}")
        # We don't exit here, we try to create infographic too

    print("Generating Infographic...")
    try:
        # Using integer codes as per signature inspection
        # orientation_code=1 (Likely Portrait)
        # detail_level_code=2 (Likely Standard)
        client.create_infographic(
            notebook.id,
            source_ids=[source_id],
            detail_level_code=2,
            orientation_code=1,
            language='en'
        )
        print("Infographic generation started.")
    except Exception as e:
        print(f"Failed to start infographic generation: {e}")

    print("\n=== SUCCESS! ===")
    print(f"Notebook: {notebook.url}")
    print(f"\nGenerations started. Wait 3-5 minutes for completion.")
    print(f"Then run: podcast-fetch \"{notebook_title}\"")

if __name__ == "__main__":
    main()
